(()=>{"use strict";const e=(e,t,o)=>{37===e.keyCode&&(t.left=o),38===e.keyCode&&(t.up=o),39===e.keyCode&&(t.right=o),40===e.keyCode&&(t.down=o),event.preventDefault()},t=(e,t,o)=>{for(let n=0;n<e.map.length;n++)for(let r=0;r<e.map[n].length;r++)t.drawImage(o,e.TILESIZE*(e.map[n][r]%e.TILECOLUMN),e.TILESIZE*Math.floor(e.map[n][r]/e.TILECOLUMN),e.TILESIZE,e.TILESIZE,e.TILESIZE*r,e.TILESIZE*n,e.TILESIZE,e.TILESIZE)};let o,n={};const r={},I={},i={up:!1,down:!1,left:!1,right:!1,move:0};let c=0;const m=document.querySelector("#canvas");let d,E,l,a,s,g;document.querySelector("body").addEventListener("click",(()=>{}));const h=io("/game",{reconnection:!0,reconnectionAttempts:3,reconnectionDelay:1e3}),p=()=>{h.emit("ready"),document.querySelector("button").removeEventListener("click",p)};let u;document.querySelector("button").addEventListener("click",p),h.on("reload",(()=>{location.reload()})),h.on("assignPlayerIdPos",(e=>{o=e.pid,console.log(o),w(e.pid,e.x,e.y,e.pNum),c=1})),h.on("pos",(e=>{u=e,console.log(u),console.log(Object.keys(u))})),h.on("startGame",(e=>{1==c?(T(e),v(e),setInterval((()=>{v(e)}),60)):location.reload()})),h.on("playerUpdate",(e=>{S(e)}));const T=e=>{const t=n[o];h.emit("playerMove",t),y(e),g=document.createElement("canvas"),I.vScreen=g,I.vScreen.width=e.TILESIZE*e.MAP_WIDTH,I.vScreen.height=e.TILESIZE*e.MAP_HEIGHT,I.rCtx=m.getContext("2d"),r.map=e,r.vCtx=g.getContext("2d"),r.mapImg=d,r.chrImg=[E,l,a,s],console.log(n[o].pNum-1),L(e),window.addEventListener("resize",(()=>{L(e)}))},v=c=>{((e,o,n)=>{const{vScreen:r,rWidth:I,rHeight:i,rCtx:c}=e;((e,o)=>{const{map:n,vCtx:r,mapImg:I}=e;t(n,r,I);for(const t in o){const n=o[t];o.length,r.drawImage(e.chrImg[n.pNum-1],n.x,n.y)}})(o,n),c.drawImage(r,0,0,r.width,r.height,0,0,I,i)})(I,r,n),addEventListener("keydown",(t=>{e(t,i,!0)}),!1),addEventListener("keyup",(t=>{e(t,i,!1)}),!1),((e,t,o)=>{if(0===o.move){const{left:n,right:r,up:I,down:i}=o,c=t.x/e.TILESIZE,m=t.y/e.TILESIZE;n&&e.moveAllow.includes(e.map[m][c-1])&&(o.move=e.TILESIZE,o.push="left"),r&&e.moveAllow.includes(e.map[m][c+1])&&(o.move=e.TILESIZE,o.push="right"),I&&m>0&&e.moveAllow.includes(e.map[m-1][c])&&(o.move=e.TILESIZE,o.push="up"),i&&m<e.MAP_WIDTH-1&&e.moveAllow.includes(e.map[m+1][c])&&(o.move=e.TILESIZE,o.push="down")}})(c,n[o],i),((e,t,o,n)=>{o.move>0&&(o.move-=32,"left"===o.push&&(t.x-=32),"up"===o.push&&(t.y-=32),"right"===o.push&&(t.x+=32),"down"===o.push&&(t.y+=32),n.emit("playerMove",t))})(0,n[o],i,h)},L=e=>{m.width=window.innerWidth/1.15,m.height=window.innerHeight/1.15;const t=m.getContext("2d");t.imageSmoothingEnabled=t.msImageSmoothingEnabled=1,I.rWidth=m.width,I.rHeight=m.height,I.rWidth/(e.TILESIZE*e.MAP_WIDTH)<I.rHeight/(e.TILESIZE*e.MAP_HEIGHT)?I.rHeight=I.rWidth*(e.TILESIZE*e.MAP_HEIGHT)/(e.TILESIZE*e.MAP_WIDTH):I.rWidth=I.rHeight*(e.TILESIZE*e.MAP_WIDTH)/(e.TILESIZE*e.MAP_HEIGHT)},S=e=>{n[o].x=e[o].x,n[o].y=e[o].y;for(const t in e)t in n?(n[t].x=e[t].x,n[t].y=e[t].y):n[t]=e[t]},w=(e,t,o,r)=>{n[e]={x:t,y:o,pNum:r}},y=e=>{d=new Image,d.src=e.MAP_IMG_PATH,E=new Image,E.src="/img/chr.png",l=new Image,l.src="/img/chr2.png",a=new Image,a.src="/img/chr3.png",s=new Image,s.src="/img/chr4.png"}})();